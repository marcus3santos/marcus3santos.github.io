<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- Jan 25, 2021 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Timing Lisp functions</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Marcus Santos" />
<link rel='icon' type='image/x-icon' href='/images/favicon.ico'/>
<meta name='viewport' content='width=device-width, initial-scale=1'>
<link rel='stylesheet' href='https://code.cdn.mozilla.net/fonts/fira.css'>
<link rel='stylesheet' href='css/site.css?v=2' type='text/css'/>
<link rel='stylesheet' href='css/custom.css' type='text/css'/>
<link rel='stylesheet' href='css/syntax-coloring.css' type='text/css'/>
<script type="text/javascript">
// @license magnet:?xt=urn:btih:e95b018ef3580986a04669f1b5879592219e2a7a&dn=public-domain.txt Public Domain
<!--/*--><![CDATA[/*><!--*/
     function CodeHighlightOn(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.add("code-highlighted");
         target.classList.add("code-highlighted");
       }
     }
     function CodeHighlightOff(elem, id)
     {
       var target = document.getElementById(id);
       if(null != target) {
         elem.classList.remove("code-highlighted");
         target.classList.remove("code-highlighted");
       }
     }
    /*]]>*///-->
// @license-end
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href="/"> UP </a>
 |
 <a accesskey="H" href="/"> HOME </a>
</div><header id="top" class="status">
<div class='intro'>
  <!--
  <img src='/images/about/profile.png' alt='Marcus Santos' class='no-border'/>
  -->
  <h1>
    <span class="gray">Marcus</span>
    <span class="black">Santos</span>
  </h1>
  <p>Emacs &  Lisp enthusiast</p>
</div>

<div class='nav'>
<ul>
<li><a href='/'>Blog</a>.</li>
<li><a href='http://github.com/'>GitHub</a>.</li>
<!--
<li><a href='https://www.reddit.com/user/'>Reddit</a>.</li>
<li><a href='/index.xml'>RSS</a>.</li>
-->
<li><a href='http://ryerson.ca/msantos/about/'>About</a>.</li>
<!-- <li><a href='/about/'>About</a></li>
-->
</ul>
</div>
</header>
<main id="content">
<h1 class="title">Timing Lisp functions
<br />
<span class="subtitle">Published on Jan 25, 2021 by Marcus Santos.</span>
</h1>
<p>
Common Lisp provides a standard utility for performance measurement, TIME:
</p>

<div class="org-src-container">
<pre class="src src-lisp">RTL-USER&gt; (time (find 4 (make-array 1000000)))
Evaluation took:
  0.008 seconds of real time
  0.007880 seconds of total run time (0.007860 user, 0.000020 system)
  100.00% CPU
  25,149,964 processor cycles
  8,000,016 bytes consed
</pre>
</div>
<p>
However, TIME merely prints textual information to trace output, so the information is not readily available for further processing (except by parsing it in a CL-implementation-specific manner).
</p>

<p>
The function GET-INTERNAL-RUN-TIME may be used to get time information programmatically, with at least one-second granularity (and usually more). The TIME-F macro below uses that function to measure the time taken for one execution of a provided function call:
</p>
<div class="org-src-container">
<pre class="src src-lisp">(<span class="org-keyword">defun</span> <span class="org-function-name">timing</span> (function)
  (<span class="org-keyword">let</span> ((run-base (get-internal-run-time)))
    (funcall function)
    (/ (- (get-internal-run-time) run-base)
       (coerce internal-time-units-per-second 'float))))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">time-f</span> (args)
  `(timing (<span class="org-keyword">lambda</span> () ,args)))
</pre>
</div>
<p>
An example of using the TIME-F macro to obtain the runtime for a call to function FIND.
</p>
<div class="org-src-container">
<pre class="src src-lisp">RTL-USER&gt; (time-f (find 4 (make-array 1000000)))
0.008
</pre>
</div>

<section id="outline-container-orgda3514f" class="outline-2">
<h2 id="orgda3514f">Timing a function considering different parameter values</h2>
<div class="outline-text-2" id="text-orgda3514f">
<p>
The steps below show how to use TIME-F to measure the runtime of function FIND for different array sizes. 
</p>

<p>
<b>Step 1</b>: Using the terminal shell, type the following commands to create a dedicated folder for your experiment, and open emacs to edit a new file called <b>timing.lisp</b>
</p>
<pre class="example" id="org0af1472">
$ cd
$ mkdir timing
$ cd timing
$ emacs -nw timing.lisp
</pre>

<p>
<b>Step 2</b>: Type in the program below in your <b>timing.lisp</b> buffer. 
</p>
<div class="org-src-container">
<pre class="src src-lisp"><span class="org-comment-delimiter">;; </span><span class="org-comment">timing.lisp</span>

(<span class="org-keyword">defun</span> <span class="org-function-name">timing</span> (function)
  (<span class="org-keyword">let</span> ((run-base (get-internal-run-time)))
    (funcall function)
    (/ (- (get-internal-run-time) run-base)
       (coerce internal-time-units-per-second 'float))))

(<span class="org-keyword">defmacro</span> <span class="org-function-name">time-f</span> (args)
  `(timing (<span class="org-keyword">lambda</span> () ,args)))

(<span class="org-keyword">with-open-file</span> (s <span class="org-string">"output.dat"</span> <span class="org-builtin">:direction</span> <span class="org-builtin">:output</span> <span class="org-builtin">:if-exists</span> <span class="org-builtin">:supersede</span>)
  (<span class="org-keyword">let</span> ((init 10000)
         (incr 20000)
         (lim 1000000)
         (reps 50))
    (<span class="org-keyword">do</span> ((i init (+ i incr))
         (k 0 (1+ k)))
        ((&gt; i lim))
      (<span class="org-keyword">let</span> ((x (make-array i))
            (acc 0)
            (yrun-times (make-array i)))
        (<span class="org-keyword">dotimes</span> (j reps)
          (<span class="org-keyword">let</span> ((run-time (time-f (find 3  x))))
            (<span class="org-builtin">:+</span> acc run-time)))  <span class="org-comment">; same as (setf acc (+ acc run-time))</span>
        (<span class="org-builtin">:=</span> (? yrun-times k) (/ acc (coerce reps 'float)))
        (format s <span class="org-string">"~a ~a~%"</span> i (? yrun-times k))))))
</pre>
</div>

<p>
<b>Step 3</b>: To run the program, <code>C-c C-k</code>. The program creates a data file called <b>output.dat</b> in you local folder.
</p>

<p>
<b>Step 4</b>: To graph the data using gnuplot, let&rsquo;s first open the emacs shell: <code>M-x</code>  type <b>eshell</b> in the minibuffer and press <code>Enter</code>.
</p>

<p>
<b>Step 5</b>: Type the following commands on the shell:
</p>
<pre class="example" id="orgb94d35c">
$ gnuplot   # This command will open the gnuplot shell
gnuplot&gt; set xlabel "Array size"
gnuplot&gt; set ylabel "Runtime"
gnuplot&gt; plot "output.dat" w lp plot
</pre>
<p>
Gnuplot will then show you the following graph in a new window:
</p>
<center>
<img src=http://www.cs.ryerson.ca/m3santos/Blog-images/output.png>
</center>
</div>
</section>
</main>
<footer id="postamble" class="status">
<div class='footer'>
  Copyright Â© 2020 <a href='mailto:m3santos@ryerson.ca'>Marcus Santos.</a><br>
  Inspired by <a href='https://nicolas.petton.fr'>https://nicolas.petton.fr</a> <br>
  Last updated on Jan 25, 2021. Generated using <a href="https://www.gnu.org/software/emacs/">Emacs</a> 27.1 (<a href="https://orgmode.org">Org</a> mode 9.4).
</div>
</footer>
</body>
</html>
